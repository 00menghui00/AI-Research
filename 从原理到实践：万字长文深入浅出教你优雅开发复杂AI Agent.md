# 从原理到实践：万字长文深入浅出教你优雅开发复杂AI Agent
- 地址：https://zhuanlan.zhihu.com/p/1919338285160965135
- 文中提出了两种使用Golang快速构建企业级agent的框架

## 背景
- 最近，大家都在讨论MCP（Model Context Protocol），它通过标准化协议，实现了工具和AI应用的解耦，推动了AI Agent应用研发范式的转变。尽管MCP非常有价值，但它并非万能。一个"聪明的"AI Agent不仅仅依赖于MCP。MCP主要解决了工具调用、Prompt模板、资源访问等标准化问题，但对于AI Agent的工具选择、任务规划、多Agent协同等核心挑战，仍存在局限，并在实际复杂应用场景中暴露出一些不足。
- Multi Agent：为了解决单Agent的局限性，多Agent生态系统应运而生。在这个阶段，不再依赖单一的"全能型"Agent，而是构建由多个专业化Agent组成的协作网络。每个Agent专注于特定领域或任务（比多工具选择更高效），通过任务分发、Agent协同来处理复杂的综合性任务。特别的，人类也可以作为一个特殊类型的 Agent 加入到智能体的协作当中（Human in the loop）。例如在Manus项目，系统会暂停并进一步确认人类的需求，等待人类确认或修正，这种人机协同的方式既保证了自动化效率，又确保了输出质量的可控性。这种"Human in the loop"的设计理念，让多Agent系统能够在保持高效自动化的同时，也能充分利用人类的智慧和经验，实现更可靠和高质量的任务完成。
- 在Agent领域，按交互对象来区分，可以分为 Context-Oriented (面向上下文) 和 Inter-Agent (面向 Agent 间) 两种。其中面向上下文的协议以 MCP 为代表，面向 Agent 间的协议以 A2A 为代表，他们分别解决了不同层面的标准化问题。

## ReAct
CoT虽然增强了模型的推理能力，但其推理过程主要局限于模型内部知识，缺乏与外部世界的实时交互，这可能导致知识陈旧、产生幻觉或错误传播。ReAct（Reasoning and Action）框架通过将"推理"（Reasoning）与"行动"（Action）相结合，有效地解决了这一问题。它允许模型在推理过程中与外部工具或环境进行互动，从而获取最新信息、执行具体操作，并根据反馈调整后续步骤。这种动态的交互赋予了模型一种"边思考边行动、边观察边调整"的能力，其核心运作机制可以概括为思考（Thought）→ 行动（Action）→ 观察（Observation）的迭代循环：

**思考 (Thought)**：模型基于当前任务目标和已有的观察信息，进行逻辑推理和规划。它会分析问题，制定策略，并决定下一步需要执行什么动作（例如，调用哪个工具、查询什么信息）来达成目标或获取关键信息。
**行动 (Action)**：根据"思考"阶段制定的计划，模型生成并执行一个具体的行动指令。这可能包括调用外部API、执行代码片段、查询数据库，或者与用户进行交互等。
**观察 (Observation)**：模型接收并处理"行动"执行后从外部环境（如工具的返回结果、API的响应、用户的回复）中获得的反馈信息。这些观察结果将作为下一轮"思考"的输入，帮助模型评估当前进展、修正错误、并迭代优化后续的行动计划，直至任务完成。

## Plan-and-Execute
Plan-and-Execute 是一种对标准 ReAct 框架的扩展和优化，旨在处理更复杂、多步骤的任务。通用AI Agent项目，如Manus、OWL、OpenManus等，均采用了这种方式对用户任务进行拆分和执行，充分展现了其普适性和高效性。它将 Agent 的工作流程明确划分为两个主要阶段：

### 规划阶段：
Agent 首先对接收到的复杂任务或目标进行整体分析和理解。然后，它会生成一个高层次的计划，将原始任务分解为一系列更小、更易于管理的子任务或步骤。这种分解有助于在执行阶段减少处理每个子任务所需的上下文长度，这个计划通常是一个有序的行动序列，指明了要达成最终目标需要完成哪些关键环节。这个蓝图可以先呈现给用户，允许用户在执行开始前对计划步骤给出修改意见。
### 执行阶段：
计划制定完成后（可能已采纳用户意见），Agent 进入执行阶段。它会按照规划好的步骤逐一执行每个子任务。在执行每个子任务时，Agent 可以采用标准的 ReAct 循环来处理该子任务的具体细节，例如调用特定工具、与外部环境交互、或进行更细致的推理。执行过程中，Agent 会监控每个子任务的完成情况。如果某个子任务成功，则继续下一个；如果遇到失败或预期之外的情况，Agent 可能需要重新评估当前计划，可以动态调整计划或返回到规划阶段进行修正。此阶段同样可以引入用户参与，允许用户对子任务的执行过程或结果进行反馈，甚至提出调整建议。

### 与标准的 ReAct 相比，Plan-and-Execute 模式的主要优势在于：

- 结构化与上下文优化：通过预先规划将复杂任务分解为小步骤，不仅使 Agent 行为更有条理，还有效减少了执行各子任务时的上下文长度，提升了处理长链条任务的效率和稳定性。
- 提升鲁棒性：将大问题分解为小问题，降低了单步决策的复杂性。如果某个子任务失败，影响范围相对可控，也更容易进行针对性的调整。
- 增强可解释性与人机协同：清晰的计划和分步执行过程使得 Agent 的行为更容易被理解和调试。更重要的是，任务的分解为用户在规划审批和执行监控等环节的参与提供了便利，用户可以对任务的执行步骤给出修改意见，从而实现更高效的人机协作，确保任务结果更符合预期。

## Agent可观测
Agent的可观测性对于保障系统的稳定性和持续优化至关重要。通过建立完善的可观测和评估体系，我们能够实时监控现网服务的运行质量，及时发现和定位故障，追踪全链路各个环境下的请求trace和耗时，为问题排查和性能瓶颈分析提供有力支撑。此外，基于对现网对话数据的质量标注，可以持续发现和归纳badcase，指导模型和业务逻辑的优化迭代，从而不断提升Agent的对话质量和用户体验。完善的可观测体系不仅有助于保障服务的可用性和可靠性，更是推动Agent"越用越聪明"、实现持续进化的基础能力。

### Langfuse
Langfuse 是一款开源的 LLM 应用可观测与分析平台，专为大模型驱动的应用（如 Agent、RAG、工具链等）设计。它帮助开发者和团队实现对 LLM 应用的全链路追踪、调试、质量评估和持续优化，是构建生产级智能体系统的"可观测性基石"。

- 数据看板：通过Dashboard，可以实时查看LLM应用的质量、成本、延迟等多维度指标，全面监控和分析智能体系统的运行状态。
- 全流程追踪：自动捕获 LLM 应用的每一次调用、嵌套的工具调用、上下文、API 请求、嵌入检索等所有关键步骤，形成完整的执行链路（Trace），用于分析每个环节的输入输出，定位问题。
- 多维度质量评估：支持将对话数据抽样生成数据集，便于人工标注和多维度输出质量评测。同时，内置 LLM-as-a-judge能力，可自动对对话质量进行多角度打分与分析，帮助业务高效发现并持续优化 badcase。
